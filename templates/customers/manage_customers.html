{% extends "base.html" %}
{% block title %}Manage Customers{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/manage_customers.css') }}" />

<div class="container">
  <h2>Manage Customers</h2>

  <button id="add-customer-btn">Add New Customer</button>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th style="text-align: center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for customer in customers %}
      <tr id="customer-{{ customer['customer_id'] }}">
        <td>{{ customer['customer_id'] }}</td>
        <td>{{ customer['full_name'] }}</td>
        <td>{{ customer['email'] }}</td>
        <td>{{ customer['phone'] or '-' }}</td>
        <td style="text-align: center">
          <button
            class="action-btn edit-btn"
            onclick="editCustomer('{{ customer['customer_id'] }}')"
          >
            Edit
          </button>
          <button
            class="action-btn delete-btn"
            onclick="deleteCustomer('{{ customer['customer_id'] }}')"
          >
            Delete
          </button>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" style="text-align: center">No customers available.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="customerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modalTitle">Add New Customer</h3>
    <form id="customerForm" method="POST" action="">
      <input type="hidden" name="customer_id" id="customer_id" />
      <label for="full_name">Full Name</label>
      <input type="text" name="name" id="full_name" required />
      <label for="email">Email</label>
      <input type="email" name="email" id="email" required />
      <label for="phone">Phone</label>
      <input type="text" name="phone" id="phone" />
      <button type="submit" style="margin-top: 15px">Save</button>
    </form>
  </div>
</div>

<script>
  // Get the modal
  const modal = document.getElementById("customerModal");

  // Get the button that opens the modal
  const addBtn = document.getElementById("add-customer-btn");

  // Get the <span> element that closes the modal
  const span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal
  addBtn.onclick = function () {
    document.getElementById("modalTitle").innerText = "Add New Customer";
    document.getElementById("customerForm").action = "{{ url_for('add_customer') }}";
    document.getElementById("customerForm").reset();
    modal.style.display = "block";
  };

  // When the user clicks on <span> (x), close the modal
  span.onclick = function () {
    modal.style.display = "none";
  };

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  };

  function editCustomer(id) {
    const row = document.getElementById("customer-" + id);
    if (!row) {
      console.error("Row with ID 'customer-" + id + "' not found.");
      return;
    }
    document.getElementById("modalTitle").innerText = "Edit Customer";
    document.getElementById("customerForm").action = "{{ url_for('edit_customer', id=123) }}".replace('123', id);
    document.getElementById("customer_id").value = id;
    document.getElementById("full_name").value = row.children[1].innerText;
    document.getElementById("email").value = row.children[2].innerText;
    document.getElementById("phone").value = row.children[3].innerText !== '-' ? row.children[3].innerText : '';
    modal.style.display = "block";
  }

  function deleteCustomer(id) {
    if (confirm("Are you sure you want to delete this customer?")) {
      window.location.href = `/customers/delete/${id}`;
    }
  }
</script>
{% endblock %}